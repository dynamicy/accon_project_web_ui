<html>
<head>
<title></title>
<link type="text/css" href="styles/prettyPhoto.css" rel="stylesheet" id="prettyphoto-css" media="all">
<link type="text/css" href="styles/osgi.style.css" rel="stylesheet">
<script type='text/javascript' src='scripts/jquery-1.8.3.min.js'></script>
<script type='text/javascript' src='scripts/jquery.prettyPhoto.js'></script>
<script type='text/javascript' src='scripts/jquery.fancygallery.min.js'></script>
<script language="JavaScript">
//<!--
	function FP_preloadImgs() {//v1.0
	 var d=document,a=arguments; if(!d.FP_imgs) d.FP_imgs=new Array();
	 for(var i=0; i<a.length; i++) { d.FP_imgs[i]=new Image; d.FP_imgs[i].src=a[i]; }
	}
	
	function FP_swapImg() {//v1.0
	 var doc=document,args=arguments,elm,n; doc.$imgSwaps=new Array(); for(n=2; n<args.length;
	 n+=2) { elm=FP_getObjectByID(args[n]); if(elm) { doc.$imgSwaps[doc.$imgSwaps.length]=elm;
	 elm.$src=elm.src; elm.src=args[n+1]; } }
	}
	
	function FP_getObjectByID(id,o) {//v1.0
	 var c,el,els,f,m,n; if(!o)o=document; if(o.getElementById) el=o.getElementById(id);
	 else if(o.layers) c=o.layers; else if(o.all) el=o.all[id]; if(el) return el;
	 if(o.id==id || o.name==id) return o; if(o.childNodes) c=o.childNodes; if(c)
	 for(n=0; n<c.length; n++) { el=FP_getObjectByID(id,c[n]); if(el) return el; }
	 f=o.forms; if(f) for(n=0; n<f.length; n++) { els=f[n].elements;
	 for(m=0; m<els.length; m++){ el=FP_getObjectByID(id,els[n]); if(el) return el; } }
	 return null;
	}
// -->
	function smart_home_req(val,obj_name){
		var msg = new Array();
		msg[0]="MMN_SmartSocketBundle.Service_SmartSocket_Interface Set_Relay1_ON";
		msg[1]="MMN_SmartSocketBundle.Service_SmartSocket_Interface Set_Relay1_OFF";
		msg[2]="MMN_SmartSocketBundle.Service_SmartSocket_Interface Set_Relay2_ON";
		msg[3]="MMN_SmartSocketBundle.Service_SmartSocket_Interface Set_Relay2_OFF";
		$.get("socket_client.php?msg="+msg[val], function(data){check_error(data,val,obj_name)});
	}
	
	function check_error(data,val,obj_name){
		//var obj_id='div_test';
		if(data=="Fail\n"){
			setTimeout(function(){smart_home_req(val,obj)},1000);
		}
		else{
			var obj = document.getElementById(obj_name);
			obj.innerHTML = data;//Return Message
		}
	}
</script>
    <script type="text/javascript">
        $(document).ready(function () 
        {
            var DataExtractor = function () 
            {
                var me = this;
                me.getBundle = function (handler) 
                {
                	$.ajax({
	                	url: '../xml_sample/alldata.xml',
	                	success: function (data) {
	                        if (handler && data) 
	                        {
	                            var devices = {};
	                            var root = $(data).find('Root');
								                                                    
	                            root.children().each(function()
	                            {
	                                var device = $(this);
	                                var did = device.attr('type').toLowerCase();
	                                var modules = {};
	                                                               
	                                device.children().each(function () 
	                                {
	                                	var module = {};
	                                	$(this).children().each(function(){
	                                		module[$(this).prop('tagName').toLowerCase()] = $(this).text();
		                                	//module[$(this).prop('address').toLowerCase()] = $(this).text();
	                                	});
	                                	
	                                	modules[module.type + '_' + module.room] = module;
	                                    //jBun[$(this).prop('tagName').toLowerCase()] = $(this).text();
	                                });
	                           
	                                devices[did] = modules;
	                                
	                            });
	                            handler(devices);
	                        }
	                    },
	                    cache: false
                	});
                	
                	/*
                    $.get('../xml_sample/alldata.xml', function (data) 
                    {
                        if (handler && data) 
                        {
                            var devices = {};
                            var root = $(data).find('Root');
							                                                    
                            root.children().each(function()
                            {
                                var device = $(this);
                                var did = device.attr('type').toLowerCase();
                                var modules = {};
                                                               
                                device.children().each(function () 
                                {
                                	var module = {};
                                	$(this).children().each(function(){
                                		module[$(this).prop('tagName').toLowerCase()] = $(this).text();
	                                	//module[$(this).prop('address').toLowerCase()] = $(this).text();
                                	});
                                	
                                	modules[module.type + '_' + module.room] = module;
                                    //jBun[$(this).prop('tagName').toLowerCase()] = $(this).text();
                                });
                           
                                devices[did] = modules;
                                
                            });
                            handler(devices);
                        }
                    });*/
                };
            };

			var ContextDataChecker = 
			{
				oldData: undefined,
				curData: undefined,
				isChanged: false,
	            onChangeHandler: {},
	            setOnChangeHandler: function(handler) 
	            {
		            if(handler) this.onChangeHandler = handler;
	            },
	            check: function(extractor) 
	            {
	            	var me = this;
	            	extractor.getBundle(function (devices) 
	            	{
	                    var zstackDevice = devices['zstack'];
	                    var aspireDevice = devices['aspire'];
	                    var smartphoneDevice = devices['smartphone'];
	                    var smartsocketDevice = devices['smartsocket'];     
	                    
						var m110n = zstackDevice['110_N'];													                    
						var m140a = zstackDevice['140_A'];
						var m140b = zstackDevice['140_B'];
						var m160a = zstackDevice['160_A'];												
						var m170a = zstackDevice['170_A'];
						var m170b = zstackDevice['170_B'];												
						var m190a = zstackDevice['190_A'];							
						
						var screena = smartsocketDevice['screen_A'];						
						var fanb = smartsocketDevice['fan_B'];						
						var lighta = smartsocketDevice['light_A'];						
						var lightb = smartsocketDevice['light_B'];																								
						
						me.curData = 
						{
							m110n: zstackDevice['110_N'],
							m140a: zstackDevice['140_A'],
							m140b: zstackDevice['140_B'],														
							m160a: zstackDevice['160_A'],							
							m170a: zstackDevice['170_A'],							
							m170b: zstackDevice['170_B'],														
							m190a: zstackDevice['190_A'],	
							screena: smartsocketDevice['screen_A'],	
							fanb: smartsocketDevice['fan_B'],	
							lighta: smartsocketDevice['light_A'],																													
							lightb: smartsocketDevice['light_B']
						};
						
						var arg = {};
						if(!me.oldData) {
							me.isChanged = true;
						}
						else {       	
			            	// compare the type of bg
							if ((me.oldData.m170a.data != me.curData.m170a.data) || (me.oldData.m170b.data != me.curData.m170b.data)) {
								me.isChanged = true;
								
			                    var aRoomLightLevel;
								var bRoomLightLevel;
											                    
								// Determine the level of the light
								if(me.curData.m170a.data < 25)
								{
									// Low
									aRoomLightLevel = 0;																		
								}
								else if(me.curData.m170a.data < 75)
								{
									// Normal
									aRoomLightLevel = 1;
								}
								else if(me.curData.m170a.data < 100)
								{
									// High
									aRoomLightLevel = 2;
								}

								if(me.curData.m170b.data < 25)
								{
									// Low
									bRoomLightLevel = 0;																		
								}
								else if(me.curData.m170b.data < 75)
								{
									// Normal
									bRoomLightLevel = 1;
								}
								else if(me.curData.m170b.data < 100)
								{
									// High
									bRoomLightLevel = 2;
								}								
								
								arg.BGURL = 'images/bg' + aRoomLightLevel + "" + bRoomLightLevel + ".png";
							}
							else {
								me.isChanged = false;
							}
						}
						
						me.oldData = me.curData;
						arg.Data = me.curData;
		            	if(me.isChanged && me.onChangeHandler) {	
							me.onChangeHandler(arg); 
		            	}
					});
	            }
            };
            
            
            var IMap = function () {
                var me = this;

                me.updata = function () {                  
                    var pins = $(".pin");
                    me.clearDirty();
                    pins.each(function () {
                        var pin = $(this);
                        var tooltipDirection = pin.hasClass('pin-down') ? 'tooltip-down' : 'tooltip-up';
                        var tooltip = $('<div class="tooltip">' + pin.html() + '</div>');
                        var dirty = $("<div style='left:" + pin.data('xpos') + "px;top:" + pin.data('ypos') + "px' class='" + tooltipDirection + "'></div>");
                        dirty.append(tooltip);
                        me.wrapper.append(dirty);
                    });

                    $('.tooltip-up, .tooltip-down').mouseenter(function () {
                        $(this).children('.tooltip').fadeIn(100);
                    }).mouseleave(function () {
                        $(this).children('.tooltip').fadeOut(100);
                    })
                };
                
                me.clearDirty = function () {
                    me.wrapper.find('.tooltip-down').remove();
                    me.wrapper.find('.tooltip-up').remove();                    
                }

                me.wrappedImg = $('#wrapper img');
                if (me.wrappedImg) {
                    me.wrapper = $('#wrapper').css({
                        'width': me.wrappedImg.width(),
                        'height': me.wrappedImg.height()
                    });                    
                    me.updata();
                }
            };
			modifyUIData();
            var map = new IMap();
            
            ContextDataChecker.setOnChangeHandler(function(arg) 
            {				    			
    			var m110n = arg.Data.m110n;							    			
    			var m140a = arg.Data.m140a;
    			var m140b = arg.Data.m140b;
    			var m160a = arg.Data.m160a;    			
    			var m170a = arg.Data.m170a;
    			var m170b = arg.Data.m170b;
    			var m190a = arg.Data.m190a;

    			var screena = arg.Data.screena;
    			var fanb = arg.Data.fanb;
    			var lighta = arg.Data.lighta;
    			var lightb = arg.Data.lightb;    			    			    			    				
    			    			
    			$('#110nAddress').text(m110n.address);       
                $('#110nType').text(m110n.type);  
                $('#110nData').text(m110n.data);                      

                $('#140aAddress').text(m140a.address);       
                $('#140aType').text(m140a.type);  
                $('#140aData').text(m140a.data); 
                                
                $('#140bAddress').text(m140b.address);       
                $('#140bType').text(m140b.type);  
                $('#140bData').text(m140b.data);    
                
                $('#160aAddress').text(m160a.address);       
                $('#160aType').text(m160a.type);  
                $('#160aData').text(m160a.data);     
                
                $('#170aAddress').text(m170a.address);       
                $('#170aType').text(m170a.type);  
                $('#170aData').text(m170a.data); 
                
                $('#170bAddress').text(m170b.address);       
                $('#170bType').text(m170b.type);  
                $('#170bData').text(m170b.data); 
                
                $('#190aAddress').text(m190a.address);       
                $('#190aType').text(m190a.type);  
                $('#190aData').text(m190a.data);                                                                                    

                $('#screenaAddress').text(screena.address);       
                $('#screenaType').text(screena.type);  
                $('#screenaData').text(screena.data);                                                                                    
                
                $('#fanbAddress').text(fanb.address);       
                $('#fanbType').text(fanb.type);  
                $('#fanbData').text(fanb.data);                                                                                    
                
                $('#lightaAddress').text(lighta.address);       
                $('#lightaType').text(lighta.type);  
                $('#lightaData').text(lighta.data);                                                                                    
                
                $('#lightbAddress').text(lightb.address);       
                $('#lightbType').text(lightb.type);  
                $('#lightbData').text(lightb.data);                                                                                    

				$('#bgsrc').attr('src', arg.BGURL);
				
                map.updata(); 
            });    
            
            var extractor = new DataExtractor();           
            setInterval(modifyUIData, 3000, extractor);

            function modifyUIData(extractor) 
            {
            	if(extractor) ContextDataChecker.check(extractor);
          		// Initial
            	if(!extractor)
            	{
                    var appBtn1 = $('#appButton1');
	                var appBtn2 = $('#appButton2');
                    var appBtn3 = $('#appButton3');
	                var appBtn4 = $('#appButton4');
                    var appBtn5 = $('#appButton5');
	                var appBtn6 = $('#appButton6');
                    var appBtn7 = $('#appButton7');
	                var appBtn8 = $('#appButton8');
	                	        
					appBtn1.hide();
					appBtn2.hide();
					appBtn3.hide();
					appBtn4.hide();
					appBtn5.hide();
					appBtn6.hide();
					appBtn7.hide();
					appBtn8.hide();																					                	                                       
	            	return;           	
            	}

            	/* Normal case
                extractor.getBundle(function (devices) 
                {
                    var zstackDevice = devices['zstack'];
                    var aspireDevice = devices['aspire'];
                    var smartphoneDevice = devices['smartphone'];
                    var smartsocketDevice = devices['smartsocket'];     
                    
					var m140a = zstackDevice['140_A'];
					var m140b = zstackDevice['140_B'];
										
                    $('#140aAddress').text(m140a.address);       
                    $('#140aType').text(m140a.type);  
                    $('#140aData').text(m140a.data);                      
                    
                    $('#140bAddress').text(m140b.address);       
                    $('#140bType').text(m140b.type);  
                    $('#140bData').text(m140b.data);                      

                    map.updata();
                });*/
            }

        });
    </script>
  </head>

<body>
<div id="wrapper">
    <img width="700" height="446" src="images/bg.png" id="bgsrc" alt="House"> 
    <div class="pin pin-down" data-xpos="63" data-ypos="120">
        <label><b>Left Light: </b></label><br>
        <label><b>Address:</b> </label><span id="lightaAddress"></span><br>        
        <label><b>Type: </b></label><span id="lightaType"></span><br>
        <label><b>Data:</b></label><span id="lightaData"></span><br>
    </div>
    <div class="pin pin-down" data-xpos="170" data-ypos="210">
        <label><b>Left Screen:</b> </label><br>
        <label><b>Address:</b> </label><span id="screenaAddress"></span><br>        
        <label><b>Type:</b> </label><span id="screenaType"></span><br>
        <label><b>Data:</b> </label><span id="screenaData"></span><br>
    </div>         
    <div class="pin pin-down" data-xpos="450" data-ypos="250">
        <label><b>Right Chair(M110):</b> </label><br>
        <label><b>Address:</b> </label><span id="110nAddress"></span><br>        
        <label><b>Type:</b> </label><span id="110nType"></span><br>
        <label><b>Data:</b> </label><span id="110nData"></span><br>
    </div>   
    <div class="pin pin-down" data-xpos="380" data-ypos="1">
        <label><b>Right Light:</b> </label><br>    
        <label><b>Address:</b> </label><span id="lightbAddress"></span><br>
        <label><b>Type:</b> </label><span id="lightbType"></span><br>
        <label><b>Data:</b> </label><span id="lightbData"></span><br>
    </div>   
    <div class="pin pin-down" data-xpos="420" data-ypos="180">
        <label><b>Right Fan:</b> </label><br>    
        <label><b>Address:</b> </label><span id="fanbaddress"></span><br>
        <label><b>Type:</b> </label><span id="fanbType"></span><br>
        <label><b>Data:</b> </label><span id="fanbData"></span><br>
    </div>                        
</div>
<div align="center" id="div_test"></div>       
</body>
</html>